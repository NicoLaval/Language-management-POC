name: Backport

on:
  pull_request:
    types: [closed]

jobs:
  backport:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Determine target branches from labels
        id: determine-branches
        run: |
          LABELS_JSON='${{ toJSON(github.event.pull_request.labels) }}'
          TARGET_BRANCHES=""
          
          # Extract label names from JSON array
          LABEL_NAMES=$(echo "$LABELS_JSON" | jq -r '.[].name' | tr '\n' ' ')
          
          echo "Detected labels: $LABEL_NAMES"
          
          # Check for backport-to-v2.2 label (backport to v2.2 and develop)
          if echo "$LABEL_NAMES" | grep -q "backport-to-v2.2"; then
            TARGET_BRANCHES="v2.2,develop"
          fi
          
          # Check for backport-to-v2.1 label (backport to v2.1)
          if echo "$LABEL_NAMES" | grep -q "backport-to-v2.1"; then
            if [ -n "$TARGET_BRANCHES" ]; then
              TARGET_BRANCHES="$TARGET_BRANCHES,v2.1"
            else
              TARGET_BRANCHES="v2.1"
            fi
          fi
          
          # Check for backport-to-v2.0 label (backport to v2.0)
          if echo "$LABEL_NAMES" | grep -q "backport-to-v2.0"; then
            if [ -n "$TARGET_BRANCHES" ]; then
              TARGET_BRANCHES="$TARGET_BRANCHES,v2.0"
            else
              TARGET_BRANCHES="v2.0"
            fi
          fi
          
          echo "target_branches=$TARGET_BRANCHES" >> $GITHUB_OUTPUT
          echo "Determined target branches: $TARGET_BRANCHES"

      - name: Backport
        if: steps.determine-branches.outputs.target_branches != ''
        uses: korthout/backport-action@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          target_branches: ${{ steps.determine-branches.outputs.target_branches }}
