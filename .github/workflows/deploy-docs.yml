name: Build and Deploy Documentation

on:
  push:
    branches:
      - main
      - v2.0
      - v2.1
      - v2.2
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-docs:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for sphinx-multiversion to access all branches

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r docs/requirements.txt

      - name: Setup PlantUML
        run: |
          wget -O /tmp/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2023.13/plantuml-1.2023.13.jar
          echo "PUML_PATH=/tmp/plantuml.jar" >> $GITHUB_ENV

      - name: Build documentation with sphinx-multiversion
        run: |
          cd docs
          sphinx-multiversion . _build/html
        env:
          SPHINX_MULTIVERSION_BUILD: "true"

      - name: Create root index.html with version selector
        run: |
          cd docs/_build/html
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>VTL Documentation - Versions</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
                max-width: 800px;
                margin: 50px auto;
                padding: 20px;
                line-height: 1.6;
                background: #f5f5f5;
              }
              .container {
                background: white;
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
              h1 {
                color: #333;
                border-bottom: 3px solid #0066cc;
                padding-bottom: 10px;
              }
              .version-list {
                list-style: none;
                padding: 0;
                margin: 30px 0;
              }
              .version-item {
                margin: 15px 0;
                padding: 15px;
                background: #f9f9f9;
                border-left: 4px solid #0066cc;
                border-radius: 4px;
              }
              .version-item a {
                text-decoration: none;
                color: #0066cc;
                font-weight: bold;
                font-size: 1.1em;
              }
              .version-item a:hover {
                text-decoration: underline;
              }
              .version-badge {
                display: inline-block;
                background: #0066cc;
                color: white;
                padding: 3px 8px;
                border-radius: 3px;
                font-size: 0.85em;
                margin-left: 10px;
              }
              .description {
                color: #666;
                margin-top: 5px;
                font-size: 0.9em;
              }
              .auto-redirect {
                margin-top: 30px;
                padding: 15px;
                background: #e3f2fd;
                border-radius: 4px;
                text-align: center;
              }
              .auto-redirect a {
                color: #0066cc;
                font-weight: bold;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>VTL Documentation</h1>
              <p>Bienvenue dans la documentation VTL (Validation and Transformation Language).</p>
              <p>Sélectionnez une version pour accéder à sa documentation :</p>
              
              <ul class="version-list">
                <li class="version-item">
                  <a href="./latest/index.html">
                    Latest (v2.2)
                    <span class="version-badge">Recommandé</span>
                  </a>
                  <div class="description">Version la plus récente avec toutes les fonctionnalités</div>
                </li>
                <li class="version-item">
                  <a href="./v2.2/index.html">Version 2.2</a>
                  <div class="description">Documentation complète de la version 2.2</div>
                </li>
                <li class="version-item">
                  <a href="./v2.1/index.html">Version 2.1</a>
                  <div class="description">Documentation de la version 2.1</div>
                </li>
              </ul>
              
              <div class="auto-redirect">
                <p>Redirection automatique vers <a href="./latest/index.html">la dernière version</a> dans 3 secondes...</p>
              </div>
            </div>
            
            <script>
              // Auto-redirect après 3 secondes
              setTimeout(function() {
                window.location.href = "./latest/index.html";
              }, 3000);
            </script>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: "./docs/_build/html"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

